{% extends 'base.html' %}
{% load static humanize %}

{% block content %}
<section id="listing-detail-screen" class="screen-page">
    <div class="detail-container">
        <!-- Back Button logic would normally be history.back() or link to category -->
        <div class="modal-header">
            <h3>Listing Details</h3>
            <a href="javascript:history.back()" class="btn-icon"><i class="ph ph-arrow-left"></i></a>
        </div>
        
        {% if house.image %}
        <img src="{{ house.image.url }}" style="width:100%; height:250px; object-fit:cover; border-radius:12px; margin-bottom:16px;" alt="{{ house.title }}">
        {% else %}
        <div style="width:100%; height:250px; background:#f0f0f0; border-radius:12px; margin-bottom:16px; display:flex; align-items:center; justify-content:center; color:#aaa;">
            <i class="ph ph-image" style="font-size:3rem;"></i>
        </div>
        {% endif %}
        
        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px; flex-direction: column; gap: 8px;">
            <h2 style="margin:0; color:var(--primary);">
                â‚¦{{ house.rent|intcomma }}/yr 
                {% if house.listing_type == 'roommate' %}
                <span style="font-size:0.9rem; color:var(--text-muted); font-weight:normal;">(50% Share)</span>
                {% endif %}
            </h2>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
                {% if house.listing_type != 'roommate' %}
                    {% if house.is_verified_listing %}
                    <span class="badge badge-verified"><i class="ph-fill ph-seal-check"></i> Verified Listing</span>
                    {% else %}
                    <span class="badge" style="background:#FEF3C7; color:#B45309;">Unverified Listing</span>
                    {% endif %}
                {% endif %}

                {% if house.posted_by.is_verified_student %}
                <span class="badge" style="background:#e0f2fe; color:#0284c7;"><i class="ph-fill ph-student"></i> Verified Student</span>
                {% else %}
                <span class="badge" style="background:#FEF3C7; color:#B45309;">Unverified User</span>
                {% endif %}
            </div>
        </div>
        
        <h3 style="margin-bottom:8px;">{{ house.title }}</h3>
        <p style="margin-bottom:16px;"><i class="ph ph-map-pin"></i> {{ house.location }}</p>
        
        {% if house.listing_type == 'roommate' %}
        <div style="background:#F8FAFC; border: 1px solid var(--border-color); border-radius:12px; padding:16px; margin-bottom:20px;">
            <h4 style="margin-bottom:12px; font-size:1rem;">About the Roommate</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:16px;">
                <div>
                    <span style="display:block; font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Gender</span>
                    <span style="font-weight:600; font-size:1.05rem;">{{ house.get_gender_preference_display|default:"Not specified" }}</span>
                </div>
                <div>
                    <span style="display:block; font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Level</span>
                    <span style="font-weight:600; font-size:1.05rem;">{{ house.get_level_preference_display|default:"Not specified" }}</span>
                </div>
                {% if house.posted_by.department %}
                <div style="grid-column: 1 / -1;">
                    <span style="display:block; font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Department</span>
                    <span style="font-weight:600; font-size:1.05rem;">{{ house.posted_by.department }}</span>
                </div>
                {% endif %}
            </div>
            
            {% if interests_list %}
            <div>
                <span style="display:block; font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">Interests & Habits</span>
                <div class="tags">
                    {% for interest in interests_list %}
                    <span class="tag" style="background:white; border:1px solid var(--border-color);">{{ interest }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div style="margin-bottom:20px;">
            <h4 style="margin-bottom:8px;">Description</h4>
            <p>{{ house.description|default:"No description provided."|linebreaks }}</p>
        </div>

        {% if house.images.all %}
        <div style="margin-bottom:20px;">
            <h4 style="margin-bottom:8px;">Photos</h4>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
                {% for img in house.images.all %}
                <div style="aspect-ratio: 1; overflow: hidden; border-radius: 8px;">
                    <img src="{{ img.image.url }}" 
                         class="gallery-image" 
                         data-index="{{ forloop.counter0 }}" 
                         style="width:100%; height:100%; object-fit:cover; cursor:pointer; transition: transform 0.3s ease;" 
                         onmouseover="this.style.transform='scale(1.05)'" 
                         onmouseout="this.style.transform='scale(1)'" 
                         alt="Gallery Image">
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div style="background:#F8FAFC; border-radius:12px; margin-bottom:20px;">
            <h4 style="margin-bottom:8px;">Details</h4>
            <div class="tags">
                <span class="tag">{{ house.get_listing_type_display }}</span>
                <a href="{% url 'user_profile' house.posted_by.id %}" class="tag" style="text-decoration:none; color:inherit; border-color:var(--primary); background:rgba(37,99,235,0.05);">
                    Posted by {{ house.posted_by.full_name }} <i class="ph-bold ph-arrow-right" style="font-size:0.8em;"></i>
                </a>
                <span class="tag">{{ house.created_at|timesince }} ago</span>
            </div>
        </div>

        <div style="display:flex; gap:12px; margin-bottom: 80px;"> <!-- Margin bottom for sticky nav -->
            <a href="tel:{{ house.posted_by.phone_number }}" class="btn btn-secondary" style="flex:1;"><i class="ph ph-phone"></i> Call Agent</a>
            <a href="https://wa.me/{{ house.posted_by.whatsapp_link }}?text=Hi, I am interested in {{ house.title }}" target="_blank" class="btn btn-primary" style="flex:1; background-color:#25D366; border:none;"><i class="ph-fill ph-whatsapp-logo"></i> WhatsApp</a>
        </div>
    </div>
</section>

<!-- Lightbox Modal -->
<div id="lightbox-modal" class="lightbox-modal">
    <span class="close-btn">&times;</span>
    <img class="lightbox-content" id="lightbox-img">
    <a class="prev" onclick="changeSlide(-1)">&#10094;</a>
    <a class="next" onclick="changeSlide(1)">&#10095;</a>
</div>

<style>
/* Lightbox styles */
.lightbox-modal {
  display: none;
  position: fixed;
  z-index: 2000; /* High z-index to overlay everything */
  padding-top: 0;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background-color: rgba(0, 0, 0, 0.95);
  align-items: center;
  justify-content: center;
  flex-direction: column;
}

.lightbox-content {
  margin: auto;
  display: block;
  max-width: 90%;
  max-height: 80vh;
  object-fit: contain;
  animation-name: zoom;
  animation-duration: 0.3s;
}

@keyframes zoom {
  from {transform:scale(0.8); opacity: 0;}
  to {transform:scale(1); opacity: 1;}
}

.close-btn {
  position: absolute;
  top: 20px;
  right: 30px;
  color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
  transition: 0.3s;
  cursor: pointer;
  z-index: 2001;
  line-height: 1;
}

.close-btn:hover,
.close-btn:focus {
  color: #bbb;
  text-decoration: none;
  cursor: pointer;
}

.prev, .next {
  cursor: pointer;
  position: absolute;
  top: 50%;
  width: auto;
  padding: 16px;
  margin-top: -22px;
  color: white;
  font-weight: bold;
  font-size: 24px;
  transition: 0.3s ease;
  border-radius: 0 3px 3px 0;
  user-select: none;
  -webkit-user-select: none;
  background-color: rgba(255,255,255,0.1);
  text-decoration: none;
}

.next {
  right: 0;
  border-radius: 3px 0 0 3px;
}

.prev {
  left: 0;
  border-radius: 3px 0 0 3px;
}

.prev:hover, .next:hover {
  background-color: rgba(255,255,255,0.3);
}

@media only screen and (max-width: 700px) {
  .lightbox-content {
    width: 100%;
  }
}
</style>

<script>
    // Collect all image URLs
    const galleryImages = [
        {% for img in house.images.all %}
            "{{ img.image.url }}",
        {% endfor %}
    ];
    
    let currentSlideIndex = 0;
    const modal = document.getElementById('lightbox-modal');
    const modalImg = document.getElementById('lightbox-img');
    const closeBtn = document.getElementsByClassName("close-btn")[0];

    // Open Modal
    document.querySelectorAll('.gallery-image').forEach((img) => {
        img.addEventListener('click', function() {
            modal.style.display = "flex";
            currentSlideIndex = parseInt(this.getAttribute('data-index'));
            showSlide(currentSlideIndex);
        });
    });

    // Close Modal
    if(closeBtn) {
        closeBtn.onclick = function() {
            modal.style.display = "none";
        }
    }
    
    // Close on outside click
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Navigation
    window.changeSlide = function(n) {
        currentSlideIndex += n;
        if (currentSlideIndex >= galleryImages.length) {
            currentSlideIndex = 0;
        } else if (currentSlideIndex < 0) {
            currentSlideIndex = galleryImages.length - 1;
        }
        showSlide(currentSlideIndex);
    }

    function showSlide(index) {
        if(galleryImages.length > 0) {
             modalImg.src = galleryImages[index];
        }
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', function(event) {
        if (modal.style.display === "flex") {
            if (event.key === "ArrowLeft") {
                changeSlide(-1);
            } else if (event.key === "ArrowRight") {
                changeSlide(1);
            } else if (event.key === "Escape") {
                modal.style.display = "none";
            }
        }
    });
</script>
{% endblock %}